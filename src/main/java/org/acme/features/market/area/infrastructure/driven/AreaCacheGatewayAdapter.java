package org.acme.features.market.area.infrastructure.driven;

import java.time.OffsetDateTime;
import java.util.List;
import java.util.Optional;

import org.acme.features.market.area.domain.gateway.AreaCacheGateway;
import org.acme.features.market.area.domain.gateway.AreaCached;
import org.acme.features.market.area.domain.gateway.AreaCursor;
import org.acme.features.market.area.domain.gateway.AreaFilter;
import org.acme.features.market.area.domain.model.Area;

import io.quarkus.cache.Cache;
import io.quarkus.cache.CacheName;
import jakarta.enterprise.context.RequestScoped;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@RequestScoped
@Slf4j
@RequiredArgsConstructor
public class AreaCacheGatewayAdapter implements AreaCacheGateway {

  /**
   * @autogenerated CacheAdaterGatewayGenerator
   */
  @CacheName("area")
  private final Cache cache;

  /**
   * @autogenerated CacheAdaterGatewayGenerator
   * @param area
   */
  @Override
  public void remove(final Area area) {
    log.trace("Invalidating area cache due to the removal of {}", area);
    invalidate();
  }

  /**
   * @autogenerated CacheAdaterGatewayGenerator
   * @param filter
   * @param cursor
   * @return
   */
  public Optional<AreaCached> retrieve(final AreaFilter filter, final AreaCursor cursor) {
    String key = key(filter, cursor);
    log.trace("Lookup at area cache for the key {}", key);
    return cache.<String, AreaCached>get(key, k -> null).map(cached -> Optional.ofNullable(cached))
        .await().indefinitely();
  }

  /**
   * @autogenerated CacheAdaterGatewayGenerator
   * @param filter
   * @param cursor
   * @param areas
   * @return
   */
  public AreaCached store(final AreaFilter filter, final AreaCursor cursor,
      final List<Area> areas) {
    String key = key(filter, cursor);
    cache.invalidate(key).await().indefinitely();
    return cache
        .<String, AreaCached>get(key,
            k -> AreaCached.builder().since(OffsetDateTime.now()).value(areas).build())
        .await().indefinitely();
  }

  /**
   * @autogenerated CacheAdaterGatewayGenerator
   * @param area
   */
  @Override
  public void update(final Area area) {
    log.trace("Invalidating area cache due to the update of {}", area);
    invalidate();
  }

  /**
   * @autogenerated CacheAdaterGatewayGenerator
   */
  private void invalidate() {
    cache.invalidateAll().await().indefinitely();
  }

  /**
   * @autogenerated CacheAdaterGatewayGenerator
   * @param filter
   * @param cursor
   * @return
   */
  private String key(final AreaFilter filter, final AreaCursor cursor) {
    return filter.toString() + "-" + cursor.toString();
  }
}
