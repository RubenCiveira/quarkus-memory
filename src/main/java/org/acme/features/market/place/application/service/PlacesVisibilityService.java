package org.acme.features.market.place.application.service;

import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Optional;
import java.util.Set;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.CompletionStage;

import org.acme.common.action.Interaction;
import org.acme.features.market.merchant.application.service.MerchantsVisibilityService;
import org.acme.features.market.place.application.PlaceDto;
import org.acme.features.market.place.application.service.event.PlaceFixedFields;
import org.acme.features.market.place.application.service.event.PlaceHiddenFields;
import org.acme.features.market.place.application.service.event.PlaceVisibilityQuery;
import org.acme.features.market.place.application.service.event.PlaceVisibleContent;
import org.acme.features.market.place.domain.Places;
import org.acme.features.market.place.domain.gateway.PlaceCursor;
import org.acme.features.market.place.domain.gateway.PlaceFilter;
import org.acme.features.market.place.domain.gateway.PlaceReadRepositoryGateway;
import org.acme.features.market.place.domain.model.Place;
import org.acme.features.market.place.domain.model.PlaceRef;

import jakarta.enterprise.context.RequestScoped;
import jakarta.enterprise.event.Event;
import lombok.RequiredArgsConstructor;

@RequestScoped
@RequiredArgsConstructor
public class PlacesVisibilityService {

  /**
   * @autogenerated VisibilityServiceGenerator
   */
  private final Places aggregate;

  /**
   * Event source for maniputale the fix over the entity fields
   *
   * @autogenerated VisibilityServiceGenerator
   */
  private final Event<PlaceFixedFields> fireFix;

  /**
   * Event source for maniputale the hide over the entity fields
   *
   * @autogenerated VisibilityServiceGenerator
   */
  private final Event<PlaceHiddenFields> fireHide;

  /**
   * Event source for maniputale the visibility filter over the entity fields
   *
   * @autogenerated VisibilityServiceGenerator
   */
  private final Event<PlaceVisibilityQuery> fireVisibleFilter;

  /**
   * Event source for maniputale the visible list
   *
   * @autogenerated VisibilityServiceGenerator
   */
  private final Event<PlaceVisibleContent> fireVisibleList;

  /**
   * @autogenerated VisibilityServiceGenerator
   */
  private final PlacesFormulaService formula;

  /**
   * @autogenerated VisibilityServiceGenerator
   */
  private final MerchantsVisibilityService merchantsVisibilityService;

  /**
   * @autogenerated VisibilityServiceGenerator
   */
  private final PlaceReadRepositoryGateway placeReadRepositoryGateway;

  /**
   * The input entity with the copy values without hidden
   *
   * @autogenerated VisibilityServiceGenerator
   * @param prev The source interaction
   * @param uid
   * @return The input entity with the copy values without hidden
   */
  public CompletionStage<Boolean> checkVisibility(Interaction prev, String uid) {
    return retrieveVisible(prev, uid).thenApply(Optional::isPresent);
  }

  /**
   * The input entity with the copy values without hidden
   *
   * @autogenerated VisibilityServiceGenerator
   * @param prev The source interaction
   * @param original The source interaction
   * @param source The source interaction
   * @return The input entity with the copy values without hidden
   */
  public CompletionStage<PlaceDto> copyWithFixed(Interaction prev, Place original,
      PlaceDto source) {
    return visiblesReferences(prev, source)
        .thenCompose(dto -> fieldsToFix(prev, original).getFixed().thenApply(fixeds -> {
          fixeds.forEach(field -> dto.fixField(field, original));
          return dto;
        })).thenCompose(fixed -> formula.copyWithFormulas(prev, original, fixed));
  }

  /**
   * The input entity with the copy values without hidden
   *
   * @autogenerated VisibilityServiceGenerator
   * @param prev The source interaction
   * @param source The source interaction
   * @return The input entity with the copy values without hidden
   */
  public CompletionStage<PlaceDto> copyWithFixed(Interaction prev, PlaceDto source) {
    return visiblesReferences(prev, source)
        .thenCompose(dto -> fieldsToFix(prev).getFixed().thenApply(fixeds -> {
          fixeds.forEach(field -> dto.fixField(field));
          return dto;
        })).thenCompose(fixed -> formula.copyWithFormulas(prev, fixed));
  }

  /**
   * The input dto with hidden values
   *
   * @autogenerated VisibilityServiceGenerator
   * @param prev The source interaction
   * @param place
   * @return The input dto with hidden values
   */
  public CompletionStage<PlaceDto> copyWithHidden(Interaction prev, Place place) {
    return fieldsToHide(prev, place).getHidden().thenApply(hidden -> {
      PlaceDto target = PlaceDto.from(place);
      hidden.forEach(target::hideField);
      return target;
    });
  }

  /**
   * initialsFixFields
   *
   * @autogenerated VisibilityServiceGenerator
   * @param prev The source interaction
   * @return initialsFixFields
   */
  public PlaceFixedFields fieldsToFix(Interaction prev) {
    CompletionStage<Set<String>> fields = fieldsToHide(prev).getHidden().thenApply(hidden -> {
      Set<String> set = new HashSet<>(aggregate.calcultadFields());
      set.addAll(hidden);
      return set;
    });
    PlaceFixedFields value = PlaceFixedFields.builder().fixed(fields).build(prev);
    fireFix.fire(value);
    return value;
  }

  /**
   * initialsFixFields
   *
   * @autogenerated VisibilityServiceGenerator
   * @param prev The source interaction
   * @param place
   * @return initialsFixFields
   */
  public PlaceFixedFields fieldsToFix(Interaction prev, PlaceRef place) {
    CompletionStage<Set<String>> fields = fieldsToFix(prev).getFixed()
        .thenCombine(fieldsToHide(prev, place).getHidden(), (set1, set2) -> {
          Set<String> set = new HashSet<>(set1);
          set.addAll(set2);
          return set;
        });
    PlaceFixedFields value = PlaceFixedFields.builder().fixed(fields).place(place).build(prev);
    fireFix.fire(value);
    return value;
  }

  /**
   * initialsHideFields
   *
   * @autogenerated VisibilityServiceGenerator
   * @param prev The source interaction
   * @return initialsHideFields
   */
  public PlaceHiddenFields fieldsToHide(Interaction prev) {
    CompletionStage<Set<String>> fields = CompletableFuture.completedFuture(Set.of());
    PlaceHiddenFields value = PlaceHiddenFields.builder().hidden(fields).build(prev);
    fireHide.fire(value);
    return value;
  }

  /**
   * initialsHideFields
   *
   * @autogenerated VisibilityServiceGenerator
   * @param prev The source interaction
   * @param place
   * @return initialsHideFields
   */
  public PlaceHiddenFields fieldsToHide(Interaction prev, PlaceRef place) {
    CompletionStage<Set<String>> fields = fieldsToHide(prev).getHidden();
    PlaceHiddenFields value = PlaceHiddenFields.builder().hidden(fields).place(place).build(prev);
    fireHide.fire(value);
    return value;
  }

  /**
   * The input entity with the copy values without hidden
   *
   * @autogenerated VisibilityServiceGenerator
   * @param prev The source interaction
   * @param filter The filter to retrieve values
   * @param cursor The filter to retrieve values
   * @return The input entity with the copy values without hidden
   */
  public CompletionStage<List<Place>> listVisibles(Interaction prev, PlaceFilter filter,
      PlaceCursor cursor) {
    return applyPreVisibilityFilter(prev, filter)
        .thenCompose(visfilter -> placeReadRepositoryGateway.list(visfilter, cursor)
            .filterAndFillAgain(values -> evaluatePostVisibility(prev, values)));
  }

  /**
   * The input entity with the copy values without hidden
   *
   * @autogenerated VisibilityServiceGenerator
   * @param prev The source interaction
   * @param uid
   * @return The input entity with the copy values without hidden
   */
  public CompletionStage<Optional<Place>> retrieveVisible(Interaction prev, String uid) {
    return applyPreVisibilityFilter(prev, PlaceFilter.builder().uid(uid).build())
        .thenCompose(filter -> placeReadRepositoryGateway.retrieve(uid, Optional.of(filter))
            .thenCompose(stored -> stored.map(retrieved -> evaluatePostVisibility(prev, retrieved))
                .orElseGet(() -> CompletableFuture.completedStage(Optional.empty()))));
  }

  /**
   * The self filter modified with the prepared values.
   *
   * @autogenerated VisibilityServiceGenerator
   * @param prev The source interaction
   * @param filter The filter to retrieve values
   * @return The self filter modified with the prepared values.
   */
  private CompletionStage<PlaceFilter> applyPreVisibilityFilter(Interaction prev,
      PlaceFilter filter) {
    PlaceVisibilityQuery visible = PlaceVisibilityQuery.builder()
        .filter(CompletableFuture.completedFuture(filter)).build(prev);
    fireVisibleFilter.fire(visible);
    return visible.getFilter();
  }

  /**
   * The input dto with hidden values
   *
   * @autogenerated VisibilityServiceGenerator
   * @param prev The source interaction
   * @param placeRefs The source interaction
   * @return The input dto with hidden values
   */
  private CompletionStage<List<Place>> evaluatePostVisibility(Interaction prev,
      List<Place> placeRefs) {
    PlaceVisibleContent list = PlaceVisibleContent.builder()
        .visibles(CompletableFuture.completedFuture(new ArrayList<>(placeRefs))).build(prev);
    fireVisibleList.fire(list);
    return list.getVisibles();
  }

  /**
   * The input dto with hidden values
   *
   * @autogenerated VisibilityServiceGenerator
   * @param prev The source interaction
   * @param placeRef The source interaction
   * @return The input dto with hidden values
   */
  private CompletionStage<Optional<Place>> evaluatePostVisibility(Interaction prev,
      Place placeRef) {
    return evaluatePostVisibility(prev, List.of(placeRef))
        .thenApply(list -> list.isEmpty() ? Optional.empty() : Optional.of(list.get(0)));
  }

  /**
   * The input entity with the copy values without hidden
   *
   * @autogenerated VisibilityServiceGenerator
   * @param prev The source interaction
   * @param source The source interaction
   * @return The input entity with the copy values without hidden
   */
  private CompletionStage<PlaceDto> visiblesReferences(Interaction prev, PlaceDto source) {
    List<CompletionStage<Boolean>> related = new ArrayList<>();
    if (null != source.getMerchant()) {
      related.add(merchantsVisibilityService.checkVisibility(prev,
          source.getMerchant().getReferenceValue()));
    }
    return CompletableFuture.allOf(related.toArray(new CompletableFuture[0]))
        .thenApply(_void -> source);
  }
}
