package org.acme.features.market.merchant.infrastructure.bootstrap;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.function.UnaryOperator;

import org.acme.common.projection.ExecutionAggregation;
import org.acme.common.projection.ExecutionNode;
import org.acme.common.projection.ParamKind;
import org.acme.common.projection.ProjectionDescriptor;
import org.acme.common.projection.RelationshipDefinition;
import org.acme.features.market.color.infrastructure.bootstrap.ColorProjectionDescriptor.ColorExecutionPlanner;
import org.acme.features.market.place.infrastructure.bootstrap.PlaceProjectionDescriptor.PlaceExecutionPlanner;

import jakarta.enterprise.context.ApplicationScoped;

@ApplicationScoped
public class MerchantProjectionDescriptor implements ProjectionDescriptor {

  /**
   * @autogenerated ProjectionDescriptorGeneratorGenerator
   */
  public static class MerchantExecutionPlanner {

    /**
     * @autogenerated ProjectionDescriptorGeneratorGenerator
     */
    private final List<ExecutionAggregation> aggregation = new ArrayList<>();

    /**
     * @autogenerated ProjectionDescriptorGeneratorGenerator
     */
    String prefix;

    /**
     * @autogenerated ProjectionDescriptorGeneratorGenerator
     */
    public MerchantExecutionPlanner() {
      this.prefix = "";
    }

    /**
     * @autogenerated ProjectionDescriptorGeneratorGenerator
     * @param prefix
     */
    public MerchantExecutionPlanner(final String prefix) {
      this.prefix = prefix + ".";
    }

    /**
     * @autogenerated ProjectionDescriptorGeneratorGenerator
     * @return
     */
    public List<ExecutionAggregation> build() {
      return aggregation;
    }

    /**
     * @autogenerated ProjectionDescriptorGeneratorGenerator
     * @return
     */
    public MerchantExecutionPlanner withColor() {
      return withColor(prefix + "color", null);
    }

    /**
     * @autogenerated ProjectionDescriptorGeneratorGenerator
     * @param alias
     * @return
     */
    public MerchantExecutionPlanner withColor(final String alias) {
      return withColor(alias, null);
    }

    /**
     * @autogenerated ProjectionDescriptorGeneratorGenerator
     * @param callback
     * @return
     */
    public MerchantExecutionPlanner withColor(final UnaryOperator<ColorExecutionPlanner> callback) {
      return withColor(prefix + "color", callback);
    }

    /**
     * @autogenerated ProjectionDescriptorGeneratorGenerator
     * @param alias
     * @param callback
     * @return
     */
    public MerchantExecutionPlanner withColor(final String alias,
        final UnaryOperator<ColorExecutionPlanner> callback) {
      aggregation
          .add(ExecutionAggregation.builder().name("color").alias(alias)
              .selection(null != callback
                  ? callback.apply(new ColorExecutionPlanner(prefix + alias)).build()
                  : List.of())
              .build());
      return this;
    }

    /**
     * @autogenerated ProjectionDescriptorGeneratorGenerator
     * @return
     */
    public MerchantExecutionPlanner withEnabled() {
      return withEnabled(prefix + "enabled");
    }

    /**
     * @autogenerated ProjectionDescriptorGeneratorGenerator
     * @param alias
     * @return
     */
    public MerchantExecutionPlanner withEnabled(final String alias) {
      aggregation.add(
          ExecutionAggregation.builder().name("enabled").alias(alias).selection(List.of()).build());
      return this;
    }

    /**
     * @autogenerated ProjectionDescriptorGeneratorGenerator
     * @return
     */
    public MerchantExecutionPlanner withKey() {
      return withKey(prefix + "key");
    }

    /**
     * @autogenerated ProjectionDescriptorGeneratorGenerator
     * @param alias
     * @return
     */
    public MerchantExecutionPlanner withKey(final String alias) {
      aggregation.add(
          ExecutionAggregation.builder().name("key").alias(alias).selection(List.of()).build());
      return this;
    }

    /**
     * @autogenerated ProjectionDescriptorGeneratorGenerator
     * @return
     */
    public MerchantExecutionPlanner withName() {
      return withName(prefix + "name");
    }

    /**
     * @autogenerated ProjectionDescriptorGeneratorGenerator
     * @param alias
     * @return
     */
    public MerchantExecutionPlanner withName(final String alias) {
      aggregation.add(
          ExecutionAggregation.builder().name("name").alias(alias).selection(List.of()).build());
      return this;
    }

    /**
     * @autogenerated ProjectionDescriptorGeneratorGenerator
     * @return
     */
    public MerchantExecutionPlanner withPlace() {
      return withPlace(prefix + "place", null);
    }

    /**
     * @autogenerated ProjectionDescriptorGeneratorGenerator
     * @param alias
     * @return
     */
    public MerchantExecutionPlanner withPlace(final String alias) {
      return withPlace(alias, null);
    }

    /**
     * @autogenerated ProjectionDescriptorGeneratorGenerator
     * @param callback
     * @return
     */
    public MerchantExecutionPlanner withPlace(final UnaryOperator<PlaceExecutionPlanner> callback) {
      return withPlace(prefix + "place", callback);
    }

    /**
     * @autogenerated ProjectionDescriptorGeneratorGenerator
     * @param alias
     * @param callback
     * @return
     */
    public MerchantExecutionPlanner withPlace(final String alias,
        final UnaryOperator<PlaceExecutionPlanner> callback) {
      aggregation
          .add(ExecutionAggregation.builder().name("place").alias(alias)
              .selection(null != callback
                  ? callback.apply(new PlaceExecutionPlanner(prefix + alias)).build()
                  : List.of())
              .build());
      return this;
    }

    /**
     * @autogenerated ProjectionDescriptorGeneratorGenerator
     * @return
     */
    public MerchantExecutionPlanner withUid() {
      return withUid(prefix + "uid");
    }

    /**
     * @autogenerated ProjectionDescriptorGeneratorGenerator
     * @param alias
     * @return
     */
    public MerchantExecutionPlanner withUid(final String alias) {
      aggregation.add(
          ExecutionAggregation.builder().name("uid").alias(alias).selection(List.of()).build());
      return this;
    }

    /**
     * @autogenerated ProjectionDescriptorGeneratorGenerator
     * @return
     */
    public MerchantExecutionPlanner withVersion() {
      return withVersion(prefix + "version");
    }

    /**
     * @autogenerated ProjectionDescriptorGeneratorGenerator
     * @param alias
     * @return
     */
    public MerchantExecutionPlanner withVersion(final String alias) {
      aggregation.add(
          ExecutionAggregation.builder().name("version").alias(alias).selection(List.of()).build());
      return this;
    }
  }

  /**
   * @autogenerated ProjectionDescriptorGeneratorGenerator
   * @param baseServer
   * @return
   */
  @Override
  public List<ExecutionNode> baseNodes(final String baseServer) {
    Map<String, RelationshipDefinition> relations = relations(baseServer);
    return List.of(
        ExecutionNode.builder().server(baseServer).endpoint("/api/market/merchants").method("GET")
            .list(true).params(Map.of()).relations(relations).build(),
        ExecutionNode.builder().server(baseServer).endpoint("/api/market/merchants/{uid}")
            .method("GET").list(false).params(Map.of("uid", ParamKind.PATH)).relations(relations)
            .build());
  }

  /**
   * @autogenerated ProjectionDescriptorGeneratorGenerator
   * @param baseServer
   * @return
   */
  private Map<String, RelationshipDefinition> relations(final String baseServer) {
    return Map.of("color",
        RelationshipDefinition.builder().list(true).id("/api/market/colors")
            .url(baseServer + "/api/market/colors").method("GET").batchParam("merchants")
            .referenceField("merchant").build(),
        "place",
        RelationshipDefinition.builder().list(true).id("/api/market/places")
            .url(baseServer + "/api/market/places").method("GET").batchParam("merchants")
            .referenceField("merchant").build());
  }
}
